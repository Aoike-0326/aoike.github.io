<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>方向ナビ（GPS専用）</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 60px;
    }
    #arrow {
      width: 120px;
      transition: transform 0.1s linear;
    }
    #start {
      padding: 10px 20px;
      font-size: 16px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>ルート案内：方向ナビ（GPS専用）</h1>
  <button id="start">開始（位置情報許可）</button>
  <div>
    <img id="arrow" src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e3/Simple_arrow.svg/200px-Simple_arrow.svg.png" alt="Arrow" />
  </div>
  <p id="info">準備中...</p>

  <script>
    const arrow = document.getElementById('arrow');
    const info = document.getElementById('info');

    const checkpoints = {
      cp3: { x: 831, y: 326 },
      cp8: { x: 714, y: 767 }
    };

    const from = checkpoints['cp3'];
    const to = checkpoints['cp8'];
    let targetAngle = calculateTargetAngle(from, to);

    function calculateTargetAngle(from, to) {
      const dx = to.x - from.x;
      const dy = to.y - from.y;
      const radians = Math.atan2(dx, dy);
      const degrees = (radians * 180) / Math.PI;
      return (degrees + 360) % 360;
    }

    function updateArrow(deviceHeading) {
      const diff = (targetAngle - deviceHeading + 360) % 360;
      arrow.style.transform = `rotate(${diff}deg)`;
      info.textContent = `現在の向き: ${Math.round(deviceHeading)}° → 目的地方位: ${Math.round(targetAngle)}°`;
    }

    function getDeviceHeadingFromGPS() {
      navigator.geolocation.watchPosition((position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const timestamp = position.timestamp;

        if (window.lastLat && window.lastLng) {
          const dx = (lng - window.lastLng) * 100000;
          const dy = (lat - window.lastLat) * 100000;
          const angle = (Math.atan2(dx, dy) * 180 / Math.PI + 360) % 360;
          updateArrow(angle);
        }

        window.lastLat = lat;
        window.lastLng = lng;
        window.lastTime = timestamp;
      }, (err) => {
        info.textContent = '位置情報の取得に失敗しました: ' + err.message;
      }, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 5000
      });
    }

    document.getElementById('start').addEventListener('click', () => {
      getDeviceHeadingFromGPS();
      info.textContent = '位置情報取得中...';
    });
  </script>
</body>
</html>
